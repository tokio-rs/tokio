jobs:
- job: loom
  displayName: Loom tests
  pool:
    vmImage: ubuntu-16.04

  steps:
  - template: azure-install-rust.yml
    parameters:
      rust_version: ${{ parameters.rust }}

  - ${{ each crate in parameters.crates }}:
    # Run with default crate features
    - script: cargo test --lib
      env:
        RUSTFLAGS: '--cfg loom'
        LOOM_MAX_PREEMPTIONS: 2
        CI: 'True'
      displayName: test ${{ crate }}
      workingDirectory: $(Build.SourcesDirectory)/${{ crate }}
